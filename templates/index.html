{% extends "base.html" %}

{% load cumulumbus %}

{% block title %}CUMULUMBUS - your stream in cloud.{% endblock %}

{% block head_extra %}
	<script src="{{ MEDIA_URL}}js/jquery.masonry.min.js"></script>
	<script type="text/javascript" src="/media/js/orbited/Orbited.js"></script>
	<script type="text/javascript" src="http://jackmort.hosted.hookbox.org/static/hookbox.js"></script>
	<script type="text/javascript">
		jQuery( window ).load( function() {
			var conn = hookbox.connect('http://jackmort.hosted.hookbox.org');
			conn.onOpen = function() { alert("connection established!"); };
			conn.onError = function(err) { alert("connection failed: " + err.msg); };

			var subscription = null;
			conn.onSubscribed = function(channelName, _subscription) {
				subscription = _subscription;                
				subscription.onPublish = function( frame ) {
					console.log( frame )
				};  
			};
			conn.subscribe( "posts" );

			$wall = jQuery( '.posts' )
			$wall.masonry({ 
				columnWidth: 50,
				itemSelector: '.post', 
				animate: true,
				animateOptions: {
					duration: 1000,
					queue: false
				}
			})
			// mark as readed
			jQuery( '.post' ).click( function() {
				var self = $( this ), id = self.attr( 'id' )
				jQuery.get( '/readed/' + id, function( data ) {
					// TODO: json, and messaging
					if ( data == 'OK' ) {
						self.remove()
						$wall.masonry()
					} else {
						alert( 'ERROR: while processing ...' )
					}
				})
			})
		})
	</script>
{% endblock %}

{% block content %}
	<div class="posts">
	{% for item in items %}
		{% render_post item %}
	{% endfor %}
	</div>
{% endblock %}
